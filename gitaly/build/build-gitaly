#!/bin/sh

# shellcheck disable=SC3040
set -eu -o pipefail

# shellcheck source=lib/libsetup
. "$(dirname "$0")"/../lib/libsetup

gitaly() {
    echo "Building gitaly"
    apk add \
        bash \
        binutils \
        cmake \
        curl \
        git \
        make \
        patch \
        rdfind \
        ruby-bundler

    apk add -t .git-deps \
        curl-dev \
        pcre2-dev \
        zlib-dev

    cd /tmp/src

    apply_patch -p1 -i /tmp/patches/gitaly-set-defaults.patch

    # Skip building ruby components, which will done in a separate stage
    touch /tmp/src/.ruby-bundle

    cat >>config.mak <<-EOF
		GIT_BUILD_OPTIONS += NO_GETTEXT=YesPlease
		GIT_BUILD_OPTIONS += NO_REGEX=YesPlease
		GIT_BUILD_OPTIONS += NO_EXPAT=YesPlease
		GIT_BUILD_OPTIONS += NO_TCLTK=YesPlease
		GIT_BUILD_OPTIONS += NO_PERL=YesPlease
		GIT_BUILD_OPTIONS += USE_LIBPCRE2=YesPlease
		GIT_BUILD_OTPIONS += NO_SYS_POLL_H=1
		GIT_BUILD_OPTIONS += ICONV_OMITS_BOM=Yes
		GIT_BUILD_OPTIONS += NO_INSTALL_HARDLINKS=YesPlease
		EOF

    make build
    make install DESTDIR=/tmp/gitaly/

    rdfind -makesymlinks true /tmp/gitaly/usr/local/bin
    _strip_binaries /tmp/gitaly
}

gitaly
